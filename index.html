<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    
    <!-- CSP adaptada a tu worker -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' * data: blob: 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *; style-src 'self' 'unsafe-inline' *; connect-src 'self' https://whispr.logise1123.workers.dev *;">
    
    <title>Whispr</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { black: '#050505', gray: '#FAFAFA' } },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 10px 30px -5px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            padding-bottom: env(safe-area-inset-bottom); 
            -webkit-tap-highlight-color: transparent;
            background-color: #FAFAFA;
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .glass-header {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #map-view-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .custom-cluster-icon div { 
            width: 36px; height: 36px; line-height: 36px; text-align: center; 
            background: #111; color: white; border-radius: 50%; border: 3px solid white; 
            font-weight: 700; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .toggle-checkbox:checked { right: 0; border-color: #111; }
        .toggle-checkbox:checked + .toggle-label { background-color: #111; }
        audio::-webkit-media-controls-panel { background-color: #f3f4f6; }
        audio::-webkit-media-controls-play-button { background-color: #e5e7eb; border-radius: 50%; }
    </style>

    <script>
        const WORKER_URL = "https://whispr.logise1123.workers.dev"; 
        
        const CATEGORIES = {
            gossip: { label: 'SECRET', color: 'bg-zinc-900 text-white' },
            humor:  { label: 'LOL', color: 'bg-yellow-300 text-yellow-900' },
            love:   { label: 'CRUSH', color: 'bg-rose-500 text-white' },
            idea:   { label: 'IDEA', color: 'bg-blue-500 text-white' },
            promo:  { label: 'PLAN', color: 'bg-emerald-500 text-white' }
        };

        let state = {
            userLocation: null,
            lastFetchLocation: null,
            range: 5000,
            authToken: null,
            currentUser: null,
            pseudonym: null,
            loadedPosts: [],
            activeFilter: 'all',
            currentTab: 'feed',
            mapInstance: null,
            markerCluster: null,
            mediaRecorder: null,
            audioChunks: [],
            audioBlobBase64: null,
            isRecording: false,
            radioMode: false,
            playedAudios: new Set()
        };

        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            initListeners();
        });

        function checkSession() {
            try {
                state.authToken = localStorage.getItem('whispr_token');
                state.currentUser = localStorage.getItem('whispr_username');
                state.pseudonym = localStorage.getItem('whispr_pseudonym') || state.currentUser;
            } catch(e){}

            if (state.authToken && state.currentUser) {
                initApp();
            } else {
                toggleModal('modal-auth', true);
            }
        }

        function initApp() {
            updateProfileUI();
            toggleModal('modal-auth', false);
            startLiveTracking();
        }

        function updateProfileUI() {
            const input = document.getElementById('prof-pseudo');
            if(input && state.pseudonym) input.value = state.pseudonym;
        }

        function initListeners() {
            on('btn-logout', 'click', logout);
            on('btn-profile', 'click', openProfile);
            on('tab-feed', 'click', () => switchTab('feed'));
            on('tab-map', 'click', () => switchTab('map'));

            // Radio Mode
            document.getElementById('radio-toggle').addEventListener('change', (e) => {
                state.radioMode = e.target.checked;
                const status = document.getElementById('radio-status');
                if(state.radioMode) {
                    status.innerText = "ON AIR";
                    status.classList.add('text-green-600');
                    checkRadioProximity();
                } else {
                    status.innerText = "OFF";
                    status.classList.remove('text-green-600');
                }
            });

            // Range Slider
            const slider = document.getElementById('rangeSlider');
            if(slider) {
                slider.addEventListener('input', (e) => {
                    state.range = parseInt(e.target.value);
                    document.getElementById('rangeValue').innerText = formatDistance(state.range);
                    if(state.currentTab === 'feed') renderPostsSmart(state.loadedPosts);
                });
                slider.addEventListener('change', () => fetchPosts());
            }

            on('btn-add-center', 'click', () => toggleModal('modal-new-post', true));
            on('btn-close-post', 'click', () => toggleModal('modal-new-post', false));
            on('btn-publish', 'click', publishPost);
            on('auth-submit', 'click', handleAuthSubmit);
            
            // Audio
            const btnRecord = document.getElementById('btn-record');
            if(btnRecord){
                const startRec = (e) => { e.preventDefault(); startRecording(); };
                const stopRec = (e) => { e.preventDefault(); stopRecording(); };
                btnRecord.addEventListener('mousedown', startRec);
                btnRecord.addEventListener('mouseup', stopRec);
                btnRecord.addEventListener('touchstart', startRec);
                btnRecord.addEventListener('touchend', stopRec);
            }
            on('btn-delete-audio', 'click', resetAudio);

            // Filtros
            document.querySelectorAll('.filter-pill').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-pill').forEach(b => {
                        b.classList.remove('bg-black', 'text-white');
                        b.classList.add('bg-white', 'text-gray-500', 'border', 'border-gray-200');
                    });
                    e.currentTarget.classList.remove('bg-white', 'text-gray-500', 'border', 'border-gray-200');
                    e.currentTarget.classList.add('bg-black', 'text-white');
                    
                    state.activeFilter = e.currentTarget.dataset.filter;
                    if(state.currentTab === 'feed') renderPostsSmart(state.loadedPosts);
                    else updateMapMarkers(state.loadedPosts);
                });
            });

            // Categoría
            document.querySelectorAll('.cat-select').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    document.querySelectorAll('.cat-select').forEach(c => c.classList.remove('ring-2', 'ring-black', 'scale-105'));
                    e.currentTarget.classList.add('ring-2', 'ring-black', 'scale-105');
                    document.getElementById('post-category').value = e.currentTarget.dataset.cat;
                });
            });
            
            // Botones de comentario (desactivados en backend pero UI presente)
            on('btn-close-comments', 'click', () => toggleModal('modal-comments', false));
        }

        function on(id, evt, handler) {
            const el = document.getElementById(id);
            if(el) el.addEventListener(evt, handler);
        }

        // --- AUTH (ADAPTADO A TU API: USER + PASS) ---
        async function handleAuthSubmit() {
            const userIn = document.getElementById('auth-username').value.trim().toLowerCase();
            const passIn = document.getElementById('auth-password').value.trim();
            
            if(!userIn || !passIn) return alert("Usuario y contraseña requeridos");

            const btn = document.getElementById('auth-submit');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Intento LOGIN
                let res = await fetch(`${WORKER_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: userIn, password: passIn})
                });
                
                // Si falla (401/404), sugerimos REGISTRO automáticamente
                if(!res.ok) {
                    const confirmRegister = confirm("Usuario no encontrado o contraseña incorrecta.\n¿Quieres crear una cuenta nueva con estos datos?");
                    if(confirmRegister) {
                        res = await fetch(`${WORKER_URL}/api/auth/register`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: userIn, password: passIn})
                        });
                    }
                }

                const data = await res.json();
                if(!res.ok) throw new Error(data.error || "Error de autenticación");
                
                finishLogin(data);

            } catch(e) { 
                alert(e.message); 
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function finishLogin(data) {
            state.authToken = data.token;
            state.currentUser = data.username;
            state.pseudonym = data.username;
            localStorage.setItem('whispr_token', data.token);
            localStorage.setItem('whispr_username', data.username);
            initApp();
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- GEO & FETCH POSTS ---
        function startLiveTracking() {
            const loading = document.getElementById('gps-loading');
            loading.classList.remove('hidden');
            
            if(!navigator.geolocation) return alert("GPS requerido");

            navigator.geolocation.watchPosition(
                (pos) => {
                    const firstTime = !state.userLocation;
                    state.userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    loading.classList.add('hidden');
                    
                    updateDistancesInUI();
                    if(state.radioMode) checkRadioProximity();

                    // Fetch si nos movemos > 500m o es la primera vez
                    if (firstTime || !state.lastFetchLocation || getDist(state.userLocation, state.lastFetchLocation) > 500) {
                        fetchPosts();
                    }
                },
                (err) => {
                    console.warn("Error GPS:", err);
                    loading.innerHTML = "<p class='text-red-500 font-bold'>Error GPS.</p>";
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        }

        async function fetchPosts() {
            if(!state.authToken || !state.userLocation) return;
            
            const feedContainer = document.getElementById('feed-container');
            if(state.loadedPosts.length === 0) {
                feedContainer.innerHTML = `<div class="flex justify-center pt-20"><div class="w-6 h-6 border-2 border-black border-t-transparent rounded-full animate-spin"></div></div>`;
            }

            try {
                // Fetch a tu API GET /api/posts
                const res = await fetch(`${WORKER_URL}/api/posts?lat=${state.userLocation.lat}&lng=${state.userLocation.lng}&range=${state.range}`, {
                    headers: { 'Authorization': `Bearer ${state.authToken}` }
                });
                
                if(res.status === 401) return logout();
                
                if(res.ok) {
                    const data = await res.json();
                    state.loadedPosts = Array.isArray(data) ? data : [];
                    state.lastFetchLocation = {...state.userLocation};
                }
            } catch(e) {
                console.error("Error API", e);
                feedContainer.innerHTML = `<div class="text-center pt-20 text-gray-400 text-xs">Error de conexión.</div>`;
            }

            renderPostsSmart(state.loadedPosts);
            if(state.currentTab === 'map') updateMapMarkers(state.loadedPosts);
        }

        function renderPostsSmart(posts) {
            const feed = document.getElementById('feed-container');
            
            // Filtrado cliente extra por si acaso, aunque la API ya filtra por rango
            let filtered = posts.filter(p => {
                p.distance = getDist(state.userLocation, p);
                if(state.activeFilter !== 'all' && p.category !== state.activeFilter) return false;
                return true;
            });

            filtered.sort((a,b) => a.distance - b.distance);

            feed.innerHTML = ''; 
            const spacer = document.createElement('div');
            spacer.className = 'h-32'; 
            
            if(filtered.length === 0) {
                feed.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i class="fa-solid fa-wind text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm font-medium">No hay posts en este rango.</p>
                        <button onclick="toggleModal('modal-new-post', true)" class="mt-4 text-xs bg-black text-white px-4 py-2 rounded-full font-bold">Publicar aquí</button>
                    </div>`;
                return;
            }

            filtered.forEach((p, index) => {
                const card = createCard(p, index);
                feed.appendChild(card);
            });
            feed.appendChild(spacer);
        }

        function createCard(p, index) {
            const div = document.createElement('div');
            div.className = "post-card bg-white p-5 mb-4 rounded-2xl shadow-soft border border-gray-50 opacity-0 animate-fade-in mx-4";
            div.style.animationDelay = `${index * 50}ms`;
            div.dataset.id = p.id;
            div.dataset.lat = p.lat;
            div.dataset.lng = p.lng;

            const cat = CATEGORIES[p.category] || CATEGORIES.gossip;
            const isAudio = p.audio ? true : false;
            
            // La API devuelve 'fire' en reactions
            const fires = p.reactions && p.reactions.fire ? p.reactions.fire.length : 0;
            const userFired = p.reactions && p.reactions.fire && p.reactions.fire.includes(state.currentUser);

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600">
                            ${p.pseudonym ? p.pseudonym.substring(0,2).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-gray-900 leading-none">${escapeHtml(p.pseudonym)}</span>
                            <span class="text-[10px] text-gray-400 font-medium mt-1">${getTimeAgo(p.timestamp)}</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="dist-label text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                            ${formatDistance(p.distance)}
                        </span>
                    </div>
                </div>
                
                <div class="mb-4 pl-10 relative">
                    ${isAudio ? `<div class="absolute -left-8 top-1 w-0.5 h-full bg-gray-100"></div>` : ''}
                    <div class="inline-block px-2 py-0.5 rounded-md text-[9px] font-black tracking-wider mb-2 ${cat.color}">
                        ${cat.label}
                    </div>
                    <p class="text-gray-800 text-[15px] font-normal leading-relaxed whitespace-pre-line">${escapeHtml(p.text)}</p>
                    
                    ${p.audio ? `
                        <div class="mt-3 flex items-center bg-gray-50 rounded-xl p-2 border border-gray-100">
                            <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center text-white mr-3 shrink-0">
                                <i class="fas fa-play text-xs pl-0.5"></i>
                            </div>
                            <audio controls src="${p.audio}" class="w-full h-8 opacity-80"></audio>
                        </div>
                    ` : ''}
                </div>

                <div class="flex items-center justify-between pl-10 pt-2 border-t border-gray-50">
                    <div class="flex gap-5">
                        <button onclick="notImplemented()" class="btn-press flex items-center gap-1.5 ${userFired ? 'text-orange-500' : 'text-gray-400'} hover:text-black transition-colors">
                            <i class="${userFired ? 'fas' : 'fas'} fa-fire text-lg"></i>
                            <span class="text-xs font-bold count-fire">${fires}</span>
                        </button>
                        <button onclick="notImplemented()" class="btn-press flex items-center gap-1.5 text-gray-400 hover:text-black transition-colors">
                            <i class="far fa-comment text-lg"></i>
                            <span class="text-xs font-bold">Comentar</span>
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        function notImplemented() {
            // Placeholder visual ya que la API proporcionada no tiene endpoints de reacción/comentarios
            // Para "perfectionist UI" no mostramos error feo, solo un feedback suave
            const t = document.createElement('div');
            t.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-xs font-bold z-[100] animate-fade-in';
            t.innerText = "Próximamente en la API";
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        // --- PUBLICAR (CREATE POST) ---
        async function publishPost() {
            const text = document.getElementById('post-input').value.trim();
            const cat = document.getElementById('post-category').value;
            // La API espera text, audio, lat, lng, pseudonym, category, expiresIn
            
            if(!text && !state.audioBlobBase64) return;
            
            const btn = document.getElementById('btn-publish');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch(`${WORKER_URL}/api/posts`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${state.authToken}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: text,
                        audio: state.audioBlobBase64,
                        category: cat,
                        lat: state.userLocation.lat,
                        lng: state.userLocation.lng,
                        pseudonym: state.pseudonym,
                        expiresIn: 24 // Hardcoded a 24h por defecto, puedes añadir selector en UI
                    })
                });
                
                if(!res.ok) throw new Error("Error publicando");

                toggleModal('modal-new-post', false);
                document.getElementById('post-input').value = '';
                resetAudio();
                setTimeout(fetchPosts, 1000); // Dar tiempo a Firestore
            } catch(e) { 
                alert("Error al publicar: " + e.message); 
            } finally {
                btn.disabled = false;
                btn.innerText = "Publicar Ahora";
            }
        }

        // --- MAPA ---
        function switchTab(tab) {
            state.currentTab = tab;
            const feedContainer = document.getElementById('feed-container');
            const mapContainer = document.getElementById('map-view-container');
            const feedBtn = document.getElementById('tab-feed');
            const mapBtn = document.getElementById('tab-map');

            if (tab === 'feed') {
                feedContainer.classList.remove('hidden');
                mapContainer.classList.add('hidden');
                feedBtn.classList.replace('text-gray-400', 'text-black');
                mapBtn.classList.replace('text-black', 'text-gray-400');
            } else {
                feedContainer.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                mapBtn.classList.replace('text-gray-400', 'text-black');
                feedBtn.classList.replace('text-black', 'text-gray-400');
                setTimeout(() => {
                    initMap();
                    state.mapInstance.invalidateSize();
                }, 100);
            }
        }

        function initMap() {
            if (state.mapInstance) return;
            const lat = state.userLocation ? state.userLocation.lat : 40.4168;
            const lng = state.userLocation ? state.userLocation.lng : -3.7038;

            state.mapInstance = L.map('map-view', { zoomControl: false, attributionControl: false })
                .setView([lat, lng], 16);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.mapInstance);

            state.markerCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: `<div>${cluster.getChildCount()}</div>`, 
                        className: 'custom-cluster-icon', 
                        iconSize: L.point(40, 40) 
                    });
                }
            });
            state.mapInstance.addLayer(state.markerCluster);
            updateMapMarkers(state.loadedPosts);
        }

        function updateMapMarkers(posts) {
            if (!state.markerCluster) return;
            state.markerCluster.clearLayers();
            const filtered = posts.filter(p => state.activeFilter === 'all' || p.category === state.activeFilter);
            filtered.forEach(p => {
                const markerIcon = L.divIcon({
                    html: `<div class="text-black text-3xl drop-shadow-md transform hover:scale-110 transition-transform cursor-pointer"><i class="fas fa-map-pin"></i></div>`,
                    className: 'bg-transparent border-none',
                    iconSize: [30, 40], iconAnchor: [15, 38]
                });
                const marker = L.marker([p.lat, p.lng], { icon: markerIcon });
                marker.bindPopup(`
                    <div class="font-sans min-w-[180px]">
                        <div class="text-[10px] font-bold text-gray-400 mb-1">Hace ${getTimeAgo(p.timestamp)}</div>
                        <p class="text-sm font-medium text-gray-900 leading-snug">${escapeHtml(p.text)}</p>
                    </div>
                `);
                state.markerCluster.addLayer(marker);
            });
        }

        // --- UTILS & AUDIO ---
        async function startRecording() {
            if (!navigator.mediaDevices) return alert("Micro no disponible");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = processAudio;
                state.mediaRecorder.start(); 
                state.isRecording = true;
                
                document.getElementById('btn-record').classList.add('bg-red-500', 'text-white', 'scale-110');
                document.getElementById('recording-indicator').classList.remove('hidden');
            } catch(e) { alert("Error micro"); }
        }

        function stopRecording() {
            if (!state.isRecording) return;
            state.mediaRecorder.stop();
            state.isRecording = false;
            document.getElementById('btn-record').classList.remove('bg-red-500', 'text-white', 'scale-110');
            document.getElementById('recording-indicator').classList.add('hidden');
        }

        function processAudio() {
            const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                state.audioBlobBase64 = reader.result; // Base64 directo
                const container = document.getElementById('audio-preview');
                container.classList.remove('hidden');
                container.innerHTML = `<audio controls src="${state.audioBlobBase64}" class="w-full h-8 mt-2"></audio>`;
                document.getElementById('btn-delete-audio').classList.remove('hidden');
            };
        }

        function resetAudio() {
            state.audioBlobBase64 = null;
            document.getElementById('audio-preview').classList.add('hidden');
            document.getElementById('btn-delete-audio').classList.add('hidden');
        }

        function checkRadioProximity() {
            if(!state.loadedPosts) return;
            state.loadedPosts.forEach(p => {
                if(p.audio && p.distance < 15 && !state.playedAudios.has(p.id)) {
                    new Audio(p.audio).play().catch(e=>{});
                    state.playedAudios.add(p.id);
                }
            });
        }
        
        function updateDistancesInUI() {
            if (!state.userLocation) return;
            document.querySelectorAll('.post-card').forEach(card => {
                const lat = parseFloat(card.dataset.lat);
                const lng = parseFloat(card.dataset.lng);
                const dist = getDist(state.userLocation, {lat, lng});
                const post = state.loadedPosts.find(p=>p.id===card.dataset.id);
                if(post) post.distance = dist;
                const label = card.querySelector('.dist-label');
                if(label) label.innerText = formatDistance(dist);
            });
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if(show) {
                el.classList.remove('hidden');
                const inner = el.querySelector('div');
                if(inner) inner.classList.add('animate-slide-up');
            } else {
                el.classList.add('hidden');
            }
        }
        function getDist(p1, p2) {
            if(!p1 || !p2) return 9999;
            const R = 6371e3; const p = Math.PI/180;
            const a = 0.5 - Math.cos((p2.lat-p1.lat)*p)/2 + Math.cos(p1.lat*p)*Math.cos(p2.lat*p)*(1-Math.cos((p2.lng-p1.lng)*p))/2;
            return 2 * R * Math.asin(Math.sqrt(a));
        }
        function formatDistance(m) { 
            if(m < 50) return 'Aquí'; 
            return m >= 1000 ? (m/1000).toFixed(1)+'km' : Math.round(m)+'m'; 
        }
        function escapeHtml(t) { return t ? t.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#039;','"':'&quot;'}[m])) : ''; }
        function getTimeAgo(iso) {
            if(!iso) return '';
            const s = Math.floor((new Date() - new Date(iso))/1000);
            if(s<60) return 'ahora'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d';
        }
        function openProfile() {
            document.getElementById('prof-pseudo').value = state.pseudonym || '';
            toggleModal('modal-profile', true);
        }
    </script>
</head>
<body class="text-brand-black h-[100dvh] flex flex-col overflow-hidden antialiased">

    <!-- HEADER -->
    <header class="glass-header sticky top-0 z-30 px-5 h-[60px] flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-black tracking-tighter">Whispr.</h1>
            <div class="flex items-center gap-2 bg-gray-100 rounded-full px-2 py-1">
                <div class="relative inline-block w-8 align-middle select-none">
                    <input type="checkbox" id="radio-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border border-gray-300 appearance-none cursor-pointer transition-all duration-300 left-0"/>
                    <label for="radio-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                </div>
                <span id="radio-status" class="text-[9px] font-black tracking-widest text-gray-400 w-10">OFF</span>
            </div>
        </div>
        <div onclick="openProfile()" class="w-9 h-9 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold cursor-pointer shadow-lg active:scale-95 transition-transform">
            <i class="fas fa-user"></i>
        </div>
    </header>

    <!-- FILTROS -->
    <div class="bg-white/90 backdrop-blur z-20 border-b border-gray-100 pb-2">
        <div class="px-6 py-3 flex items-center gap-4">
            <i class="fas fa-location-crosshairs text-gray-300 text-xs"></i>
            <input type="range" min="100" max="10000" step="100" value="5000" id="rangeSlider" class="flex-1 h-1 bg-gray-200 rounded-full appearance-none cursor-pointer accent-black">
            <span id="rangeValue" class="text-[10px] font-bold text-black w-12 text-right">5.0km</span>
        </div>
        <div class="flex overflow-x-auto px-5 gap-2 hide-scrollbar pb-2">
            <button data-filter="all" class="filter-pill bg-black text-white px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Todos</button>
            <button data-filter="gossip" class="filter-pill bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Secretos</button>
            <button data-filter="humor" class="filter-pill bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Humor</button>
            <button data-filter="love" class="filter-pill bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Crush</button>
            <button data-filter="idea" class="filter-pill bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Ideas</button>
            <button data-filter="promo" class="filter-pill bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all">Planes</button>
        </div>
    </div>

    <!-- MAIN -->
    <main class="flex-1 relative overflow-hidden bg-gray-50">
        <div id="feed-container" class="absolute inset-0 overflow-y-auto pt-4 z-10 hide-scrollbar pb-32">
            <div id="gps-loading" class="flex flex-col items-center justify-center h-full text-gray-300 gap-3">
                <i class="fas fa-satellite-dish fa-spin text-2xl"></i>
                <p class="text-[10px] font-bold uppercase tracking-widest">Conectando...</p>
            </div>
        </div>
        <div id="map-view-container" class="hidden absolute inset-0 z-0 bg-gray-100">
            <div id="map-view" class="w-full h-full opacity-0 animate-fade-in" style="animation-fill-mode: forwards;"></div>
        </div>
    </main>

    <!-- NAV -->
    <div class="fixed bottom-0 left-0 right-0 h-[80px] pointer-events-none z-40 flex justify-center items-end pb-6">
        <div class="glass-nav pointer-events-auto bg-white/90 rounded-full shadow-float px-8 py-3 flex items-center gap-12 mb-2 mx-4 border border-white/50">
            <button id="tab-feed" class="btn-press flex flex-col items-center justify-center text-black w-10">
                <i class="fas fa-stream text-lg mb-1"></i>
            </button>
            <button id="btn-add-center" class="btn-press bg-black text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg -mt-10 border-4 border-gray-50 transform transition-transform hover:-translate-y-1">
                <i class="fas fa-plus text-xl"></i>
            </button>
            <button id="tab-map" class="btn-press flex flex-col items-center justify-center text-gray-400 w-10">
                <i class="fas fa-map text-lg mb-1"></i>
            </button>
        </div>
    </div>

    <!-- MODAL POST -->
    <div id="modal-new-post" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-black tracking-wider text-gray-300 uppercase">Nuevo Whispr</span>
                <button id="btn-close-post" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="flex justify-between mb-6 px-2">
                <button data-cat="gossip" class="cat-select w-10 h-10 rounded-full bg-zinc-900 text-white flex items-center justify-center shadow-md transition-transform"><i class="fas fa-user-secret text-xs"></i></button>
                <button data-cat="humor" class="cat-select w-10 h-10 rounded-full bg-yellow-300 text-yellow-900 flex items-center justify-center shadow-md transition-transform"><i class="fas fa-laugh text-xs"></i></button>
                <button data-cat="love" class="cat-select w-10 h-10 rounded-full bg-rose-500 text-white flex items-center justify-center shadow-md transition-transform"><i class="fas fa-heart text-xs"></i></button>
                <button data-cat="idea" class="cat-select w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-md transition-transform"><i class="fas fa-lightbulb text-xs"></i></button>
                <button data-cat="promo" class="cat-select w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md transition-transform"><i class="fas fa-beer text-xs"></i></button>
            </div>
            <input type="hidden" id="post-category" value="gossip">
            <textarea id="post-input" rows="4" class="w-full text-xl font-medium placeholder-gray-300 border-none focus:ring-0 resize-none p-2 bg-transparent leading-relaxed" placeholder="Cuenta algo anónimo..."></textarea>
            <div class="flex items-center gap-3 mt-4 bg-gray-50 p-3 rounded-2xl">
                <button id="btn-record" class="w-10 h-10 rounded-full bg-white text-black shadow-sm flex items-center justify-center transition-all active:scale-90">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="flex-1 overflow-hidden">
                    <p id="recording-indicator" class="text-xs text-red-500 font-bold hidden animate-pulse">Grabando audio...</p>
                    <div id="audio-preview" class="hidden"></div>
                </div>
                <button id="btn-delete-audio" class="text-gray-400 hover:text-red-500 hidden px-2"><i class="fas fa-trash"></i></button>
            </div>
            <button id="btn-publish" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-sm shadow-lg mt-6 hover:bg-gray-900 active:scale-[0.98] transition-all">
                Publicar Ahora
            </button>
        </div>
    </div>

    <!-- MODAL AUTH -->
    <div id="modal-auth" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 animate-fade-in">
        <h1 class="text-5xl font-black tracking-tighter mb-2">Whispr.</h1>
        <p class="text-gray-400 mb-10 text-sm font-medium">Servidor Real. Login Seguro.</p>
        <div class="w-full max-w-xs space-y-4">
            <input id="auth-username" class="w-full bg-gray-50 border-0 rounded-2xl px-5 py-4 font-bold text-sm focus:ring-2 ring-black transition-all" placeholder="Usuario" autocomplete="username">
            <input id="auth-password" type="password" class="w-full bg-gray-50 border-0 rounded-2xl px-5 py-4 font-bold text-sm focus:ring-2 ring-black transition-all" placeholder="Contraseña" autocomplete="current-password">
            <button id="auth-submit" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-transform">Entrar</button>
        </div>
    </div>

    <!-- MODAL PROFILE -->
    <div id="modal-profile" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 text-center shadow-2xl animate-slide-up relative">
            <button onclick="toggleModal('modal-profile', false)" class="absolute top-4 right-4 text-gray-300 hover:text-black"><i class="fas fa-times"></i></button>
            <div class="w-24 h-24 bg-black text-white rounded-full mx-auto mb-4 flex items-center justify-center text-3xl shadow-lg">
                <i class="fas fa-user-astronaut"></i>
            </div>
            <h3 class="text-lg font-bold mb-6">Tu Perfil</h3>
            <input id="prof-pseudo" readonly class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 mb-4 text-center font-bold text-sm text-gray-500" placeholder="Alias">
            <button id="btn-logout" class="text-red-500 text-xs font-bold py-2">Cerrar Sesión</button>
        </div>
    </div>
    
    <!-- MODAL COMMENTS (Placeholder) -->
    <div id="modal-comments" class="hidden fixed inset-0 z-[55] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 flex flex-col h-[40vh] shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-4">
                <span class="text-xs font-black text-gray-300 uppercase">Comentarios</span>
                <button id="btn-close-comments"><i class="fas fa-chevron-down text-gray-400"></i></button>
            </div>
            <div class="flex-1 flex flex-col items-center justify-center text-gray-300 text-center px-8">
                <i class="fas fa-hammer text-4xl mb-3"></i>
                <p class="text-sm font-bold text-gray-400">En construcción</p>
                <p class="text-xs mt-1">La API actual aún no soporta comentarios.</p>
            </div>
        </div>
    </div>

</body>
</html>
