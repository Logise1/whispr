<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    
    <!-- CSP: Permitimos conexiones a Google/Firebase -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' * data: blob: 'unsafe-inline' 'unsafe-eval';">
    
    <title>Whispr</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { black: '#050505', gray: '#FAFAFA' } },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pulse-radar': 'pulseRadar 2s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        pulseRadar: { '0%': { transform: 'scale(0.8)', opacity: '0.7' }, '100%': { transform: 'scale(2.5)', opacity: '0' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { padding-bottom: env(safe-area-inset-bottom); -webkit-tap-highlight-color: transparent; background-color: #FAFAFA; }
        .glass-nav { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-header { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.03); }
        .btn-press:active { transform: scale(0.95); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        #map-view-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        
        /* Marcadores Minimalistas */
        .custom-cluster-icon div { width: 32px; height: 32px; line-height: 32px; text-align: center; background: #111; color: white; border-radius: 50%; font-weight: 700; font-size: 11px; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .user-pulse { width: 16px; height: 16px; background: #2563EB; border: 2px solid white; border-radius: 50%; animation: pulse-ring 2s infinite; }
        .radio-pulse { width: 16px; height: 16px; background: #10B981; border: 2px solid white; border-radius: 50%; animation: pulse-ring-green 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        @keyframes pulse-ring-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        /* Player de audio custom */
        audio { height: 30px; border-radius: 20px; width: 100%; }
        audio::-webkit-media-controls-panel { background-color: #f3f4f6; }
        audio::-webkit-media-controls-play-button { background-color: #e5e7eb; border-radius: 50%; }
    </style>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp, updateDoc, doc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'whispr-dev';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO GLOBAL ---
        window.state = {
            user: null,
            userLocation: null,
            range: 50,
            activeFilter: 'all',
            currentTab: 'feed',
            posts: [],
            map: null,
            markers: null,
            userMarker: null,
            isRadioPlaying: false,
            playedAudios: new Set(),
            audioBlobBase64: null,
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false,
            recordStartTime: 0,
            recordInterval: null
        };

        // --- AUTH ---
        window.handleAuth = async () => {
            const userIn = document.getElementById('auth-username').value.trim();
            const passIn = document.getElementById('auth-password').value;
            if(!userIn || !passIn) return alert("Faltan datos");
            
            const fakeEmail = `${userIn.toLowerCase().replace(/\s/g,'')}@whispr.app`;
            const btn = document.getElementById('auth-submit');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, fakeEmail, passIn);
            } catch (e) {
                if (e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found') {
                    if (confirm("Usuario no encontrado. ¿Crear cuenta nueva?")) {
                        try {
                            const cred = await createUserWithEmailAndPassword(auth, fakeEmail, passIn);
                            await updateProfile(cred.user, { displayName: userIn });
                        } catch (regErr) { alert("Error registro: " + regErr.message); }
                    }
                } else { alert("Error login: " + e.message); }
            } finally { btn.innerText = "Entrar / Registrar"; btn.disabled = false; }
        };

        window.doLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                document.getElementById('modal-auth').classList.add('hidden');
                document.getElementById('prof-pseudo').value = user.displayName || 'Anon';
                initRealtimeListener();
            } else {
                document.getElementById('modal-auth').classList.remove('hidden');
            }
        });

        // --- FIRESTORE ---
        let unsubscribe = null;
        function initRealtimeListener() {
            if(unsubscribe) unsubscribe();
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            const q = query(postsRef, orderBy('timestamp', 'desc'), limit(150));

            unsubscribe = onSnapshot(q, (snapshot) => {
                const now = new Date();
                state.posts = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const ts = d.timestamp ? d.timestamp.toDate() : new Date();
                    const exp = d.expiresAt ? d.expiresAt.toDate() : null;
                    return { id: doc.id, ...d, timestamp: ts, expiresAt: exp };
                }).filter(p => !p.expiresAt || p.expiresAt > now);
                refreshUI();
            });
        }

        // --- UI & LOGIC ---
        window.refreshUI = () => {
            if(!state.userLocation) return; 
            state.posts.forEach(p => p.distance = getDist(state.userLocation, p));
            if(state.currentTab === 'feed') renderFeed();
            if(state.currentTab === 'map' || state.currentTab === 'radio') updateMapMarkers();
            if(state.currentTab === 'radio') checkRadio();
        };

        function renderFeed() {
            const container = document.getElementById('feed-container');
            const filtered = state.posts
                .filter(p => p.distance <= state.range)
                .filter(p => state.activeFilter === 'all' || p.category === state.activeFilter)
                .sort((a,b) => a.distance - b.distance);

            container.innerHTML = '';
            if(filtered.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 text-sm animate-pulse">Nada en ${state.range}m.</div>`;
                return;
            }
            filtered.forEach(p => container.appendChild(createCard(p)));
            container.appendChild(document.createElement('div')).className = 'h-32';
        }

        function createCard(p) {
            const div = document.createElement('div');
            div.className = "post-card bg-white p-5 mb-4 rounded-2xl shadow-soft border border-gray-50 mx-4 animate-fade-in";
            
            const cats = { gossip: 'bg-zinc-900', humor: 'bg-yellow-400', love: 'bg-rose-500', idea: 'bg-blue-500', promo: 'bg-emerald-500' };
            const color = cats[p.category] || 'bg-gray-500';
            const isLiked = p.likes && p.likes.includes(state.user.uid);

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600">${p.authorName ? p.authorName.substring(0,2).toUpperCase() : '?'}</div>
                        <div class="flex flex-col"><span class="font-bold text-sm">${p.authorName || 'Anon'}</span><span class="text-[10px] text-gray-400">${getTimeAgo(p.timestamp)}</span></div>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${formatDist(p.distance)}</span>
                </div>
                <div class="mb-4 pl-10">
                    ${p.audio ? `<div class="w-2 h-2 rounded-full mb-2 ${color}"></div>` : `<div class="w-1.5 h-1.5 rounded-full mb-2 ${color}"></div>`}
                    <p class="text-gray-800 text-[15px] whitespace-pre-line">${escapeHtml(p.text)}</p>
                    ${p.audio ? `<div class="mt-3 flex items-center bg-gray-50 rounded-xl p-2 border border-gray-100"><div onclick="new Audio('${p.audio}').play()" class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center mr-3 cursor-pointer"><i class="fas fa-play text-xs"></i></div><span class="text-xs text-gray-400">Audio</span></div>` : ''}
                </div>
                <div class="flex items-center pl-10 gap-6">
                    <button onclick="toggleLike('${p.id}')" class="flex items-center gap-1.5 ${isLiked ? 'text-orange-500' : 'text-gray-400'}"><i class="${isLiked ? 'fas' : 'fas'} fa-fire text-lg"></i><span class="text-xs font-bold">${p.likes ? p.likes.length : 0}</span></button>
                </div>
            `;
            return div;
        }

        // --- MAPA ---
        function initMap() {
            if(state.map) return;
            state.map = L.map('map-view', { zoomControl: false }).setView([state.userLocation.lat, state.userLocation.lng], 18);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);
            state.markers = L.markerClusterGroup({ showCoverageOnHover: false, iconCreateFunction: (c) => L.divIcon({ html: `<div>${c.getChildCount()}</div>`, className: 'custom-cluster-icon', iconSize: L.point(32, 32) }) });
            state.map.addLayer(state.markers);
            updateUserMarker();
        }

        function updateMapMarkers() {
            if(!state.markers) return;
            state.markers.clearLayers();
            const visible = state.posts.filter(p => state.activeFilter === 'all' || p.category === state.activeFilter);
            visible.forEach(p => {
                const m = L.marker([p.lat, p.lng], { icon: L.divIcon({ html: `<div class="text-black text-3xl drop-shadow-md"><i class="fas fa-map-pin"></i></div>`, className: 'bg-transparent border-none', iconSize: [30, 40], iconAnchor: [15, 38] }) });
                state.markers.addLayer(m);
            });
        }

        function updateUserMarker() {
            if(!state.map) return;
            const pulseClass = state.currentTab === 'radio' ? 'radio-pulse' : 'user-pulse';
            const icon = L.divIcon({ className: 'bg-transparent border-none', html: `<div class="${pulseClass}"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
            
            if(state.userMarker) {
                state.userMarker.setLatLng([state.userLocation.lat, state.userLocation.lng]);
                if(!state.userMarker._icon.innerHTML.includes(pulseClass)) state.userMarker.setIcon(icon);
            } else {
                state.userMarker = L.marker([state.userLocation.lat, state.userLocation.lng], { icon: icon, zIndexOffset: 1000 }).addTo(state.map);
            }
            if(state.currentTab === 'radio') state.map.panTo([state.userLocation.lat, state.userLocation.lng], { animate: true });
        }

        // --- RADIO (3 Metros) ---
        function checkRadio() {
            if(state.isRadioPlaying || !state.userLocation) return;
            
            const candidates = state.posts
                .filter(p => p.audio && p.distance < 3 && !state.playedAudios.has(p.id))
                .sort((a,b) => a.distance - b.distance);

            if(candidates.length > 0) {
                const post = candidates[0];
                state.isRadioPlaying = true;
                state.playedAudios.add(post.id);
                
                const info = document.getElementById('radio-playing-info');
                info.classList.remove('hidden');
                info.querySelector('.author').innerText = post.authorName;
                
                const audio = new Audio(post.audio);
                audio.onended = () => {
                    state.isRadioPlaying = false;
                    info.classList.add('hidden');
                    checkRadio();
                };
                audio.play().catch(() => state.isRadioPlaying = false);
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        // --- PUBLICAR ---
        window.publishPost = async () => {
            const text = document.getElementById('post-input').value.trim();
            const cat = document.getElementById('post-category').value;
            const btn = document.getElementById('btn-publish');
            
            if((!text && !state.audioBlobBase64) || !state.userLocation) return;
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                    text: text,
                    audio: state.audioBlobBase64 || null,
                    lat: state.userLocation.lat,
                    lng: state.userLocation.lng,
                    category: cat,
                    authorUid: state.user.uid,
                    authorName: state.user.displayName,
                    likes: [],
                    timestamp: serverTimestamp(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
                });
                
                toggleModal('modal-new-post', false);
                document.getElementById('post-input').value = '';
                resetAudio();
            } catch(e) { alert("Error: " + e.message); } 
            finally { btn.innerText = "Publicar"; btn.disabled = false; }
        };

        window.toggleLike = async (id) => {
            if(!state.user) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'posts', id);
            const post = state.posts.find(p => p.id === id);
            const isLiked = post.likes && post.likes.includes(state.user.uid);
            await updateDoc(ref, { likes: isLiked ? arrayRemove(state.user.uid) : arrayUnion(state.user.uid) });
        };

        // --- UTILS ---
        window.switchTab = (t) => {
            state.currentTab = t;
            ['feed','radio','map'].forEach(x => {
                document.getElementById(`tab-${x}`).classList.toggle('text-black', x===t);
                document.getElementById(`tab-${x}`).classList.toggle('text-gray-400', x!==t);
            });
            document.getElementById('feed-container').classList.toggle('hidden', t!=='feed');
            document.getElementById('map-view-container').classList.toggle('hidden', t==='feed');
            document.getElementById('radio-badge').classList.toggle('hidden', t!=='radio');
            if(t === 'map' || t === 'radio') { setTimeout(() => { initMap(); if(state.map) state.map.invalidateSize(); updateUserMarker(); }, 100); }
            refreshUI();
        };

        // --- GRABACIÓN DE AUDIO (FIXED) ---
        window.toggleRecording = async () => {
            if (state.isRecording) {
                // STOP RECORDING
                if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                    state.mediaRecorder.stop();
                }
            } else {
                // START RECORDING
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); // Prefer webm
                    state.audioChunks = [];
                    
                    state.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) state.audioChunks.push(e.data);
                    };

                    state.mediaRecorder.onstop = () => {
                        const mimeType = state.audioChunks[0]?.type || 'audio/webm';
                        const blob = new Blob(state.audioChunks, { type: mimeType });
                        const reader = new FileReader();
                        
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            state.audioBlobBase64 = reader.result;
                            
                            // Mostrar Player
                            const ui = document.getElementById('audio-ui');
                            ui.innerHTML = `<audio controls src="${state.audioBlobBase64}"></audio>`;
                            
                            // UI Updates
                            document.getElementById('btn-rec').innerHTML = '<i class="fas fa-microphone"></i>';
                            document.getElementById('btn-rec').classList.remove('bg-red-500', 'animate-pulse-fast', 'text-white');
                            document.getElementById('btn-rec').classList.add('bg-gray-100', 'text-black', 'hidden'); // Hide mic, show delete
                            document.getElementById('del-audio').classList.remove('hidden');
                            document.getElementById('rec-status').classList.add('hidden');
                            
                            clearInterval(state.recordInterval);
                        };
                        
                        // Stop tracks
                        stream.getTracks().forEach(t => t.stop());
                    };

                    state.mediaRecorder.start();
                    state.isRecording = true;
                    state.recordStartTime = Date.now();
                    
                    // UI Updates
                    const btn = document.getElementById('btn-rec');
                    btn.innerHTML = '<i class="fas fa-stop"></i>';
                    btn.classList.remove('bg-gray-100', 'text-black');
                    btn.classList.add('bg-red-500', 'animate-pulse-fast', 'text-white');
                    
                    const status = document.getElementById('rec-status');
                    status.classList.remove('hidden');
                    status.innerText = "00:00";
                    
                    state.recordInterval = setInterval(() => {
                        const sec = Math.floor((Date.now() - state.recordStartTime) / 1000);
                        const m = Math.floor(sec / 60).toString().padStart(2,'0');
                        const s = (sec % 60).toString().padStart(2,'0');
                        status.innerText = `${m}:${s}`;
                    }, 1000);

                } catch(e) {
                    alert("No se pudo acceder al micrófono: " + e.message);
                }
            }
        };

        window.resetAudio = () => {
            state.audioBlobBase64 = null;
            state.audioChunks = [];
            state.isRecording = false;
            if(state.recordInterval) clearInterval(state.recordInterval);
            
            document.getElementById('audio-ui').innerHTML = '';
            document.getElementById('del-audio').classList.add('hidden');
            document.getElementById('rec-status').classList.add('hidden');
            
            const btn = document.getElementById('btn-rec');
            btn.classList.remove('hidden', 'bg-red-500', 'animate-pulse-fast', 'text-white');
            btn.classList.add('bg-gray-100', 'text-black');
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
        };

        // GPS
        navigator.geolocation.watchPosition(
            (pos) => {
                const newLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if (!state.userLocation || getDist(state.userLocation, newLoc) > 2) {
                    state.userLocation = newLoc;
                    document.getElementById('gps-loading').classList.add('hidden');
                    refreshUI();
                }
            },
            () => {}, { enableHighAccuracy: true }
        );

        // Helpers UI
        window.toggleModal = (id, show) => { const el = document.getElementById(id); if(show) { el.classList.remove('hidden'); el.querySelector('div').classList.add('animate-slide-up'); } else el.classList.add('hidden'); };
        function getDist(p1, p2) { const R=6371e3, p=Math.PI/180, a=0.5-Math.cos((p2.lat-p1.lat)*p)/2+Math.cos(p1.lat*p)*Math.cos(p2.lat*p)*(1-Math.cos((p2.lng-p1.lng)*p))/2; return 2*R*Math.asin(Math.sqrt(a)); }
        function formatDist(m) { return m<10?'Aquí':(m>=1000?(m/1000).toFixed(1)+'km':Math.round(m)+'m'); }
        function escapeHtml(t) { return t?t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#039;','"':'&quot;'}[m])):''; }
        function getTimeAgo(d) { const s=Math.floor((new Date()-d)/1000); if(s<60)return'ahora'; if(s<3600)return Math.floor(s/60)+'m'; return Math.floor(s/3600)+'h'; }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('rangeSlider').addEventListener('input', e => { state.range = parseInt(e.target.value); document.getElementById('rangeValue').innerText = formatDist(state.range); refreshUI(); });
            document.querySelectorAll('.cat-btn').forEach(b => b.addEventListener('click', e => {
                document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('ring-2','ring-black'));
                e.currentTarget.classList.add('ring-2','ring-black');
                document.getElementById('post-category').value = e.currentTarget.dataset.cat;
            }));
        });
    </script>
</head>
<body class="text-brand-black h-[100dvh] flex flex-col overflow-hidden antialiased">

    <!-- HEADER -->
    <header class="glass-header sticky top-0 z-30 px-5 h-[60px] flex justify-between items-center">
        <h1 class="text-2xl font-black tracking-tighter">Whispr.</h1>
        <div onclick="toggleModal('modal-profile',true)" class="w-9 h-9 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold shadow-lg"><i class="fas fa-user"></i></div>
    </header>

    <!-- FILTERS -->
    <div class="bg-white/90 backdrop-blur z-20 border-b border-gray-100 pb-2">
        <div class="px-6 py-3 flex items-center gap-4">
            <i class="fas fa-location-crosshairs text-gray-300 text-xs"></i>
            <input type="range" min="10" max="200" step="10" value="50" id="rangeSlider" class="flex-1 h-1 bg-gray-200 rounded-full cursor-pointer accent-black">
            <span id="rangeValue" class="text-[10px] font-bold text-black w-12 text-right">50m</span>
        </div>
        <div class="flex overflow-x-auto px-5 gap-2 hide-scrollbar pb-2">
            <button onclick="state.activeFilter='all';refreshUI()" class="bg-black text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">Todos</button>
            <button onclick="state.activeFilter='gossip';refreshUI()" class="bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">Secretos</button>
            <button onclick="state.activeFilter='humor';refreshUI()" class="bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">Humor</button>
            <button onclick="state.activeFilter='love';refreshUI()" class="bg-white text-gray-500 border border-gray-200 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">Crush</button>
        </div>
    </div>

    <!-- MAIN -->
    <main class="flex-1 relative overflow-hidden bg-gray-50">
        <div id="feed-container" class="absolute inset-0 overflow-y-auto pt-4 z-10 hide-scrollbar pb-32">
            <div id="gps-loading" class="flex flex-col items-center justify-center h-full text-gray-300 gap-3"><i class="fas fa-satellite-dish fa-spin text-2xl"></i><p class="text-[10px] uppercase">Conectando...</p></div>
        </div>
        
        <div id="map-view-container" class="hidden absolute inset-0 z-0 bg-gray-100">
            <div id="map-view" class="w-full h-full opacity-0 animate-fade-in"></div>
            <!-- Radio Badge -->
            <div id="radio-badge" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur text-white px-4 py-2 rounded-full flex items-center gap-2 z-[400] shadow-lg">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><span class="text-xs font-bold tracking-widest">RADIO ACTIVA</span>
            </div>
            <!-- Player -->
            <div id="radio-playing-info" class="hidden absolute bottom-24 left-4 right-4 z-[500]">
                <div class="bg-black/90 text-white backdrop-blur rounded-full px-5 py-3 shadow-xl border border-emerald-500/50 flex items-center gap-3">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <div class="flex flex-col overflow-hidden"><span class="text-[9px] font-bold text-emerald-400 uppercase tracking-widest">ON AIR</span><span class="author text-xs font-bold truncate">...</span></div>
                </div>
            </div>
        </div>
    </main>

    <!-- NAV -->
    <div class="fixed bottom-0 left-0 right-0 h-[80px] pointer-events-none z-40 flex justify-center items-end pb-6">
        <div class="glass-nav pointer-events-auto rounded-full shadow-float px-6 py-3 flex items-center gap-8 mb-2 mx-4">
            <button id="tab-feed" onclick="switchTab('feed')" class="btn-press flex flex-col items-center justify-center text-black w-12"><i class="fas fa-stream text-lg mb-1"></i><span class="text-[9px] font-bold">LISTA</span></button>
            <button id="tab-radio" onclick="switchTab('radio')" class="btn-press flex flex-col items-center justify-center text-gray-400 w-12"><i class="fas fa-broadcast-tower text-lg mb-1"></i><span class="text-[9px] font-bold">RADIO</span></button>
            <button id="tab-map" onclick="switchTab('map')" class="btn-press flex flex-col items-center justify-center text-gray-400 w-12"><i class="fas fa-map text-lg mb-1"></i><span class="text-[9px] font-bold">MAPA</span></button>
        </div>
        <button onclick="toggleModal('modal-new-post',true)" class="pointer-events-auto absolute bottom-24 right-6 bg-black text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-white active:scale-90 transition-transform z-50"><i class="fas fa-plus text-xl"></i></button>
    </div>

    <!-- MODAL POST -->
    <div id="modal-new-post" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6"><span class="text-xs font-black text-gray-300 uppercase">Nuevo Whispr</span><button onclick="toggleModal('modal-new-post',false)"><i class="fas fa-times text-gray-500"></i></button></div>
            <div class="flex justify-between mb-6 px-2">
                <button data-cat="gossip" class="cat-btn w-10 h-10 rounded-full bg-zinc-900 text-white flex items-center justify-center shadow-md"><i class="fas fa-user-secret"></i></button>
                <button data-cat="humor" class="cat-btn w-10 h-10 rounded-full bg-yellow-300 text-yellow-900 flex items-center justify-center shadow-md"><i class="fas fa-laugh"></i></button>
                <button data-cat="love" class="cat-btn w-10 h-10 rounded-full bg-rose-500 text-white flex items-center justify-center shadow-md"><i class="fas fa-heart"></i></button>
                <button data-cat="idea" class="cat-btn w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-md"><i class="fas fa-lightbulb"></i></button>
                <button data-cat="promo" class="cat-btn w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md"><i class="fas fa-beer"></i></button>
            </div>
            <input type="hidden" id="post-category" value="gossip">
            <textarea id="post-input" rows="4" class="w-full text-xl font-medium placeholder-gray-300 border-none focus:ring-0 resize-none p-2 bg-transparent" placeholder="Cuenta algo..."></textarea>
            
            <div class="flex items-center gap-3 mt-4 bg-gray-50 p-3 rounded-2xl">
                <!-- Botón de Grabar con Toggle -->
                <button id="btn-rec" onclick="toggleRecording()" class="w-10 h-10 rounded-full bg-gray-100 text-black shadow-sm flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                
                <div class="flex-1 overflow-hidden">
                    <p id="rec-status" class="text-xs text-red-500 font-bold hidden animate-pulse">00:00</p>
                    <div id="audio-ui"></div>
                </div>
                <button id="del-audio" onclick="resetAudio()" class="hidden text-gray-400"><i class="fas fa-trash"></i></button>
            </div>
            <button id="btn-publish" onclick="publishPost()" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-sm shadow-lg mt-6">Publicar</button>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="modal-auth" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 animate-fade-in">
        <h1 class="text-5xl font-black tracking-tighter mb-2">Whispr.</h1>
        <p class="text-gray-400 mb-10 text-sm font-medium">Servidor Real. Sin Lag.</p>
        <div class="w-full max-w-xs space-y-4">
            <input id="auth-username" class="w-full bg-gray-50 border-0 rounded-2xl px-5 py-4 font-bold text-sm focus:ring-2 ring-black" placeholder="Usuario">
            <input id="auth-password" type="password" class="w-full bg-gray-50 border-0 rounded-2xl px-5 py-4 font-bold text-sm focus:ring-2 ring-black" placeholder="Contraseña">
            <button id="auth-submit" onclick="handleAuth()" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-sm shadow-lg">Entrar / Registrar</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="modal-profile" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 text-center shadow-2xl animate-slide-up relative">
            <button onclick="toggleModal('modal-profile',false)" class="absolute top-4 right-4 text-gray-300 hover:text-black"><i class="fas fa-times"></i></button>
            <div class="w-24 h-24 bg-black text-white rounded-full mx-auto mb-4 flex items-center justify-center text-3xl shadow-lg"><i class="fas fa-user-astronaut"></i></div>
            <h3 class="text-lg font-bold mb-6">Tu Perfil</h3>
            <input id="prof-pseudo" readonly class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 mb-4 text-center font-bold text-sm text-gray-500">
            <button onclick="doLogout()" class="text-red-500 text-xs font-bold py-2">Cerrar Sesión</button>
        </div>
    </div>

</body>
</html>
